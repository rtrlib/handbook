

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Usage of the RTRlib C Library &mdash; The RTRlib Handbook 0.4 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="RTRlib Python Binding" href="python.html" />
    <link rel="prev" title="Introduction" href="intro.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> The RTRlib Handbook
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage of the RTRlib C Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#archlinux">Archlinux</a></li>
<li class="toctree-l3"><a class="reference internal" href="#apple-macos">Apple macOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gentoo">Gentoo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debian">Debian</a></li>
<li class="toctree-l3"><a class="reference internal" href="#from-source">From Source</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#development-with-rtrlib">Development with RTRlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-by-step-example">Step-by-Step Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#complete-rtrlib-example">Complete RTRlib Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="python.html">RTRlib Python Binding</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools based on the RTRlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="bgprd.html">BGP Routing Daemons with RPKI/RTR</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">The RTRlib Handbook</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Usage of the RTRlib C Library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/usage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="usage-of-the-rtrlib-c-library">
<span id="usage"></span><h1>Usage of the RTRlib C Library<a class="headerlink" href="#usage-of-the-rtrlib-c-library" title="Permalink to this headline">¶</a></h1>
<p>The RTRlib is supported by most Linux distributions as well as Apple macOS.
Before you start using or developing with the RTRlib C library, you have to
prepare your OS environment by installing a recent release package.</p>
<div class="section" id="installation">
<span id="install"></span><h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>To install or build the RTRlib from source follow the steps described here.</p>
<div class="section" id="archlinux">
<h3>Archlinux<a class="headerlink" href="#archlinux" title="Permalink to this headline">¶</a></h3>
<p>For Archlinux we maintain two PKGBUILDs in the Archlinux User Repository,
rtrlib <a class="footnote-reference" href="#rtrlib" id="id1">[1]</a> and rtrlib-git <a class="footnote-reference" href="#rtrlibgit" id="id2">[2]</a>.
The former is for the latest official release and the latter for current git master.
You can either use your favourite aur helper or execute the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo pacman --needed base-devel

<span class="c1"># for the latest release</span>
wget https://aur.archlinux.org/cgit/aur.git/snapshot/rtrlib.tar.gz
tar xf rtrlib
<span class="nb">cd</span> rtrlib

<span class="c1"># for the git version</span>
wget https://aur.archlinux.org/cgit/aur.git/snapshot/rtrlib-git.tar.gz
tar xf rtrlib-git
<span class="nb">cd</span> rtrlib-git

<span class="c1"># for both</span>
makepkg -sci
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="rtrlib" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://aur.archlinux.org/packages/rtrlib/">https://aur.archlinux.org/packages/rtrlib/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="rtrlibgit" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://aur.archlinux.org/packages/rtrlib-git/">https://aur.archlinux.org/packages/rtrlib-git/</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="apple-macos">
<h3>Apple macOS<a class="headerlink" href="#apple-macos" title="Permalink to this headline">¶</a></h3>
<p>For macOS we provide a <em>Homebrew tap</em> to easily install the RTRlib.
First, setup Homebrew <a class="footnote-reference" href="#homebrew" id="id3">[3]</a> and afterwards install the RTRlib package:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>brew tap rtrlib/pils
brew install rtrlib
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="homebrew" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>Homebrew – <a class="reference external" href="http://brew.sh">http://brew.sh</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="gentoo">
<h3>Gentoo<a class="headerlink" href="#gentoo" title="Permalink to this headline">¶</a></h3>
<p>The kind guys from the FRRouting project maintain a gentoo overlay <a class="footnote-reference" href="#overlay" id="id4">[4]</a> that contains an ebuild for the RTRlib.
First, setup layman <a class="footnote-reference" href="#layman" id="id5">[5]</a>, then install rtrlib with the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># If this doe not work try layman -f</span>
layman -a frr-gentoo
emerge rtrlib
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="overlay" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="https://github.com/FRRouting/gentoo-overlay">https://github.com/FRRouting/gentoo-overlay</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="layman" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="https://wiki.gentoo.org/wiki/Layman">https://wiki.gentoo.org/wiki/Layman</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="debian">
<h3>Debian<a class="headerlink" href="#debian" title="Permalink to this headline">¶</a></h3>
<p>Debian contains RTRlib since Buster <a class="footnote-reference" href="#debianbuster" id="id6">[6]</a> and can be installed with apt.
The package is called <code class="docutils literal notranslate"><span class="pre">librtr0</span></code>, developers will require the <code class="docutils literal notranslate"><span class="pre">librtr-dev</span></code> package, too.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>apt install librtr0 librtr-dev
</pre></div>
</div>
<p>Debugging Symbols(<code class="docutils literal notranslate"><span class="pre">librtr0-dbgsym</span></code>) and offline documentation (<code class="docutils literal notranslate"><span class="pre">librtr-doc</span></code>) are also available.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="debianbuster" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td>Buster is currently in testing and scheduled for release Mid 2019</td></tr>
</tbody>
</table>
</div>
<div class="section" id="from-source">
<h3>From Source<a class="headerlink" href="#from-source" title="Permalink to this headline">¶</a></h3>
<p>On any other Linux OS you will have to build and install the RTRlib from source.
The following minimal requirements have to be met, before building the library:</p>
<ul class="simple">
<li>the build system is based on <cite>cmake</cite>, version &gt;= 2.6</li>
<li><cite>libssh</cite>, to establish SSH transport connections, version &gt;= 0.5.0</li>
</ul>
<p>Optional requirements are:</p>
<ul class="simple">
<li><cite>cmocka</cite>, a framework to run RTRlib unit tests</li>
<li><cite>doxygen</cite>, to build the RTRlib API documentation</li>
</ul>
<p>If the requirements are fulfilled in the system, the library and tools can be build.
First, either download or clone the RTRlib source code as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://github.com/rtrlib/rtrlib/archive/v0.3.6.tar.gz
tar xzf v0.3.6.tar.gz
<span class="nb">cd</span> rtrlib-0.3.6
<span class="c1"># or</span>
git clone https://github.com/rtrlib/rtrlib/
<span class="nb">cd</span> rtrlib
</pre></div>
</div>
<p>The contents of the RTRlib source code has the following subdirectory structure:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">cmake/</span></code>      CMake modules</li>
<li><code class="docutils literal notranslate"><span class="pre">doxygen/</span></code>    Example code and graphics used in the Doxygen documentation</li>
<li><code class="docutils literal notranslate"><span class="pre">rtrlib/</span></code>     Header and source code files of the RTRlib</li>
<li><code class="docutils literal notranslate"><span class="pre">tests/</span></code>      Function tests and unit tests</li>
<li><code class="docutils literal notranslate"><span class="pre">tools/</span></code>      Contains <code class="docutils literal notranslate"><span class="pre">rtrclient</span></code> and <code class="docutils literal notranslate"><span class="pre">cli-validator</span></code></li>
</ul>
<p>Afterwards, the library can be build (we recommend an <cite>out-of-source</cite> build)
using <cite>cmake</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd</span> build
cmake -DCMAKE_BUILD_TYPE<span class="o">=</span>Release ../
make
sudo make install
</pre></div>
</div>
<p>If the build command fails with any error, please consult the RTRlib README <a class="footnote-reference" href="#readme" id="id7">[7]</a>
and Wiki <a class="footnote-reference" href="#wiki" id="id8">[8]</a>, you may also join our <cite>mailing list</cite> <a class="footnote-reference" href="#mailinglist" id="id9">[9]</a> or open
an issue on Github <a class="footnote-reference" href="#issue" id="id10">[10]</a>.</p>
<p>To enable debug symbols and messages, change the <cite>cmake</cite> command to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cmake -D <span class="nv">CMAKE_BUILD_TYPE</span><span class="o">=</span>Debug ../
</pre></div>
</div>
<p>For developers we provide a pre-build Doxygen API reference online <a class="footnote-reference" href="#doxygen" id="id11">[11]</a>
for the latest release of the RTRlib. Alternatively, and if <cite>Doxygen</cite> is
available on your system, you can build the documentation locally as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make doc
</pre></div>
</div>
<p>Further, you can also run the build-in tests provided by the RTRlib package
via <cite>make</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make <span class="nb">test</span>
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="readme" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td>README – <a class="reference external" href="https://github.com/rtrlib/rtrlib/blob/master/README">https://github.com/rtrlib/rtrlib/blob/master/README</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="wiki" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td>Wiki – <a class="reference external" href="https://github.com/rtrlib/rtrlib/wiki">https://github.com/rtrlib/rtrlib/wiki</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="mailinglist" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[9]</a></td><td>Mailing list – <a class="reference external" href="https://groups.google.com/forum/#!forum/rtrlib">https://groups.google.com/forum/#!forum/rtrlib</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="issue" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[10]</a></td><td>Issue tracker – <a class="reference external" href="https://github.com/rtrlib/rtrlib/issues">https://github.com/rtrlib/rtrlib/issues</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="doxygen" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[11]</a></td><td>API reference – <a class="reference external" href="https://rtrlib.realmv6.org/doxygen/latest">https://rtrlib.realmv6.org/doxygen/latest</a></td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="development-with-rtrlib">
<span id="devel"></span><h2>Development with RTRlib<a class="headerlink" href="#development-with-rtrlib" title="Permalink to this headline">¶</a></h2>
<p>The RTRlib shared library is installed to <code class="docutils literal notranslate"><span class="pre">/usr/local/lib</span></code> by default,
and its headers files to <code class="docutils literal notranslate"><span class="pre">/usr/local/include</span></code>, respectively.
To write an application in C/C++ using the RTRlib, include the main header file
into the code:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;rtrlib/rtrlib.h&quot;</span><span class="cp"></span>
</pre></div>
</div>
<p>The name of the corresponding shared library is <cite>rtr</cite>.
To link an application against the RTRlib, pass the following parameter to the
compiler:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>-lrtr
</pre></div>
</div>
<p>If the linker reports an error such as <code class="docutils literal notranslate"><span class="pre">cannot</span> <span class="pre">find</span> <span class="pre">-lrtr</span></code>, probably the
RTRlib was not installed to a standard location.
In this case, pass its location as an absolute path to the compiler,
add parameter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>-L&lt;/path/to/librtr/&gt;
</pre></div>
</div>
<p>On Linux you can alternatively try to update the linker cache instead,
run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ldconfig
<span class="c1"># verify with</span>
ldconfig -p <span class="p">|</span> grep rtr
</pre></div>
</div>
</div>
<div class="section" id="step-by-step-example">
<span id="coding"></span><h2>Step-by-Step Example<a class="headerlink" href="#step-by-step-example" title="Permalink to this headline">¶</a></h2>
<p>The RTRlib package includes two command line tools, the <code class="docutils literal notranslate"><span class="pre">rtrclient</span></code> and
the <code class="docutils literal notranslate"><span class="pre">cli-validator</span></code>, see also <a class="reference internal" href="tools.html#tools"><span class="std std-ref">Tools based on the RTRlib</span></a>.
The former connects to a single RTR cache server via TCP or SSH and prints
validated prefix origin data to STDOUT. You can use this tool to get first
experiences with the RPKI-RTR protocol. With the latter you can validate
arbitrary prefix origin AS relations against records received from a connected
RPKI cache. Both tools are located in the <code class="docutils literal notranslate"><span class="pre">tools/</span></code> directory. Having a look
into the source code of these tools will help to understand and integrate the
RTRlib into applications.</p>
<hr class="docutils" />
<p>Any application using the RTRlib will have to setup a RTR connection manager
that handles synchronization with one (or multiple) trusted RPKI cache server(s).
The following provides an overview on important code segments.</p>
<p>First, create a RTR transport socket, for instance using TCP as shown in
<a class="reference internal" href="#lst-create-socket"><span class="std std-numref">Listing 1</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="lst-create-socket">
<div class="code-block-caption"><span class="caption-number">Listing 1 </span><span class="caption-text">Create a RTR transport socket</span><a class="headerlink" href="#lst-create-socket" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">tr_socket</span> <span class="n">tr_tcp</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">rtr_socket</span> <span class="n">rtr_tcp</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">tcp_host</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;rpki-validator.realmv6.org&quot;</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">tcp_port</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;8282&quot;</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">tr_tcp_config</span> <span class="n">tcp_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">tcp_host</span><span class="p">,</span>   <span class="c1">// cache server host</span>
    <span class="n">tcp_port</span><span class="p">,</span>   <span class="c1">// cache server port</span>
    <span class="nb">NULL</span>        <span class="c1">// source address, empty</span>
<span class="p">};</span>

<span class="n">tr_tcp_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr_tcp</span><span class="p">);</span>
<span class="n">rtr_tcp</span><span class="p">.</span><span class="n">tr_socket</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tr_tcp</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Afterwards, create a group of RTR cache servers with preference <cite>1</cite>.
In this example (see <a class="reference internal" href="#lst-create-group"><span class="std std-numref">Listing 2</span></a>), it includes only a single
cache instance.</p>
<div class="literal-block-wrapper docutils container" id="lst-create-group">
<div class="code-block-caption"><span class="caption-number">Listing 2 </span><span class="caption-text">Create a group of RTR caches</span><a class="headerlink" href="#lst-create-group" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">rtr_mgr_group</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sockets</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtr_socket</span><span class="o">*</span><span class="p">));</span>
<span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sockets_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtr_tcp</span><span class="p">;</span>
<span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">preference</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Now initialize the RTR connection manager (<a class="reference internal" href="#lst-init-rtrmgr"><span class="std std-numref">Listing 3</span></a>) providing
a pointer to a configuration object, the preconfigured group(s), number
of groups, a refresh interval, an expiration interval, and retry interval,
as well as distinct callback functions.
In this case, a refresh interval of 30 seconds, a 600s expiration timeout,
and a 600s retry interval will be defined.
Afterwards, start the RTR Connection Manager.</p>
<div class="literal-block-wrapper docutils container" id="lst-init-rtrmgr">
<div class="code-block-caption"><span class="caption-number">Listing 3 </span><span class="caption-text">Initialize the RTR connection manager.</span><a class="headerlink" href="#lst-init-rtrmgr" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">rtr_mgr_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">rtr_mgr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span>
                       <span class="n">pfx_update_fp</span><span class="p">,</span> <span class="n">spki_update_fp</span><span class="p">,</span> <span class="n">status_fp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="n">rtr_mgr_start</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>As soon as an update has been received from the RTR-Server, the callback
function will be invoked. In this example, <cite>update_cb</cite> (see <a class="reference internal" href="#lst-callback"><span class="std std-numref">Listing 4</span></a>)
is called which prints the prefix, its minimum, and maximum length, as well as
the corresponding origin AS.</p>
<div class="literal-block-wrapper docutils container" id="lst-callback">
<div class="code-block-caption"><span class="caption-number">Listing 4 </span><span class="caption-text">RTR connection manager update callback</span><a class="headerlink" href="#lst-callback" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">update_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pfx_table</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="n">pfx_record</span> <span class="n">rec</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">added</span><span class="p">){</span>
    <span class="kt">char</span> <span class="n">ip</span><span class="p">[</span><span class="n">INET6_ADDRSTRLEN</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">added</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;+ &quot;</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;- &quot;</span><span class="p">);</span>
    <span class="n">ip_addr_to_str</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">prefix</span><span class="p">),</span> <span class="n">ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-18s %3u-%-3u %10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">min_len</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">max_len</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">asn</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>With a running RTR connection manager, you can also execute validation queries.
For instance, validate the relation of prefix <cite>10.10.0.0/24</cite> and its origin
AS 12345 as shown in <a class="reference internal" href="#lst-validate"><span class="std std-numref">Listing 5</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="lst-validate">
<div class="code-block-caption"><span class="caption-number">Listing 5 </span><span class="caption-text">Validate a prefix to origin AS relation</span><a class="headerlink" href="#lst-validate" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">lrtr_ip_addr</span> <span class="n">pref</span><span class="p">;</span>
<span class="n">lrtr_ip_str_to_addr</span><span class="p">(</span><span class="s">&quot;10.10.0.0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pref</span><span class="p">);</span>
<span class="k">enum</span> <span class="n">pfxv_state</span> <span class="n">result</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
<span class="n">rtr_mgr_validate</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="mi">12345</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pref</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>For a clean shutdown and exit of the application, first stop the RTR
Connection Manager, and secondly release any memory allocated
(see <a class="reference internal" href="#lst-stop-rtrmgr"><span class="std std-numref">Listing 6</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="lst-stop-rtrmgr">
<div class="code-block-caption"><span class="caption-number">Listing 6 </span><span class="caption-text">RTR connection manager cleanup</span><a class="headerlink" href="#lst-stop-rtrmgr" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">rtr_mgr_stop</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
<span class="n">rtr_mgr_free</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
<span class="n">free</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sockets</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="complete-rtrlib-example">
<h2>Complete RTRlib Example<a class="headerlink" href="#complete-rtrlib-example" title="Permalink to this headline">¶</a></h2>
<p>The code in <a class="reference internal" href="#lst-full-example"><span class="std std-numref">Listing 7</span></a> shows a fully functional RPKI validator
using the RTRlib. It includes all parts explained in the previous section, and
shows how to setup multiple RPKI cache server connections using either TCP or
SSH transport sockets. For the latter, the RTRlib has to be build and installed
with <cite>libssh</cite> support.</p>
<div class="literal-block-wrapper docutils container" id="lst-full-example">
<div class="code-block-caption"><span class="caption-number">Listing 7 </span><span class="caption-text">A complete code example for the RTRlib</span><a class="headerlink" href="#lst-full-example" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;rtrlib/rtrlib.h&quot;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="c1">//create a SSH transport socket</span>
    <span class="kt">char</span> <span class="n">ssh_host</span><span class="p">[]</span>     <span class="o">=</span> <span class="s">&quot;123.231.123.221&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">ssh_user</span><span class="p">[]</span>     <span class="o">=</span> <span class="s">&quot;rpki_user&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">ssh_hostkey</span><span class="p">[]</span>  <span class="o">=</span> <span class="s">&quot;/etc/rpki-rtr/hostkey&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">ssh_privkey</span><span class="p">[]</span>  <span class="o">=</span> <span class="s">&quot;/etc/rpki-rtr/client.priv&quot;</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">tr_socket</span> <span class="n">tr_ssh</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">tr_ssh_config</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ssh_host</span><span class="p">,</span>       <span class="c1">//IP</span>
        <span class="mi">22</span><span class="p">,</span>             <span class="c1">//Port</span>
        <span class="nb">NULL</span><span class="p">,</span>           <span class="c1">//Source address</span>
        <span class="n">ssh_user</span><span class="p">,</span>
        <span class="n">ssh_hostkey</span><span class="p">,</span>    <span class="c1">//Server hostkey</span>
        <span class="n">ssh_privkey</span><span class="p">,</span>    <span class="c1">//Private key</span>
    <span class="p">};</span>
    <span class="n">tr_ssh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr_ssh</span><span class="p">);</span>

    <span class="c1">//create a TCP transport socket</span>
    <span class="k">struct</span> <span class="n">tr_socket</span> <span class="n">tr_tcp</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">tcp_host</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;rpki-validator.realmv6.org&quot;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">tcp_port</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;8282&quot;</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">tr_tcp_config</span> <span class="n">tcp_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">tcp_host</span><span class="p">,</span> <span class="c1">//IP</span>
        <span class="n">tcp_port</span><span class="p">,</span> <span class="c1">//Port</span>
        <span class="nb">NULL</span>      <span class="c1">//Source address</span>
    <span class="p">};</span>
    <span class="n">tr_tcp_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr_tcp</span><span class="p">);</span>

    <span class="c1">//create 3 rtr_sockets and associate them with the transprort sockets</span>
    <span class="k">struct</span> <span class="n">rtr_socket</span> <span class="n">rtr_ssh</span><span class="p">,</span> <span class="n">rtr_tcp</span><span class="p">;</span>
    <span class="n">rtr_ssh</span><span class="p">.</span><span class="n">tr_socket</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tr_ssh</span><span class="p">;</span>
    <span class="n">rtr_tcp</span><span class="p">.</span><span class="n">tr_socket</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tr_tcp</span><span class="p">;</span>

    <span class="c1">//create a rtr_mgr_group array with 2 elements</span>
    <span class="k">struct</span> <span class="n">rtr_mgr_group</span> <span class="n">groups</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="c1">//The first group contains both TCP RTR sockets</span>
    <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sockets</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtr_socket</span><span class="o">*</span><span class="p">));</span>
    <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sockets_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtr_tcp</span><span class="p">;</span>
    <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">preference</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">//Preference value of this group</span>

    <span class="c1">//The seconds group contains only the SSH RTR socket</span>
    <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sockets</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtr_socket</span><span class="o">*</span><span class="p">));</span>
    <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sockets_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtr_ssh</span><span class="p">;</span>
    <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">preference</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="c1">//create a rtr_mgr_config struct that stores the group</span>
    <span class="k">struct</span> <span class="n">rtr_mgr_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>

    <span class="c1">//initialize all rtr_sockets in the server pool with the same settings</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">rtr_mgr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">//start the connection manager</span>
    <span class="n">rtr_mgr_start</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

    <span class="c1">//wait till at least one rtr_mgr_group is fully synchronized with the server</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">rtr_mgr_conf_in_sync</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//validate the BGP-Route 10.10.0.0/24, origin ASN: 12345</span>
    <span class="k">struct</span> <span class="n">lrtr_ip_addr</span> <span class="n">pref</span><span class="p">;</span>
    <span class="n">lrtr_ip_str_to_addr</span><span class="p">(</span><span class="s">&quot;10.10.0.0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pref</span><span class="p">);</span>
    <span class="k">enum</span> <span class="n">pfxv_state</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
    <span class="n">rtr_mgr_validate</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="mi">12345</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pref</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

    <span class="c1">//output the result of the prefix validation above</span>
    <span class="c1">//to showcase the returned states.</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">INET_ADDRSTRLEN</span><span class="p">];</span>
    <span class="n">lrtr_ip_addr_to_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pref</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;RESULT: The prefix %s/%i &quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">BGP_PFXV_STATE_VALID</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;is valid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">BGP_PFXV_STATE_INVALID</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;is invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">BGP_PFXV_STATE_NOT_FOUND</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;was not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// cleanup before exit</span>
    <span class="n">rtr_mgr_stop</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
    <span class="n">rtr_mgr_free</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sockets</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sockets</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="python.html" class="btn btn-neutral float-right" title="RTRlib Python Binding" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="intro.html" class="btn btn-neutral" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2017, Sebastian Meiling, Marcel Röthke, and Colin Sames, for HAW Hamburg

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>